#eseguo la query
dati <- sqldf(paste("select * from dati1 where facol_cod_primo=='",codici.fac[i],"' and COORTE='2008-2010' and cdl_cod_primo==''",sep=""))
sel <- dati$IMMARANK
sel.desc <- unique(data.frame(dati$IMMARANK,dati$IMMARANK_desc))
sel.desc <- sel.desc[order(sel.desc[,1]),]
names(sel.desc) <- c("IMMARANK","IMMARANK_desc")
print(dim(sel.desc))
if(dim(dati)[1]==0){
i <- i+1
}
else{
#costruzione variabili
indirizzo.lat <- dati$indirizzo_lat
indirizzo.lng <- dati$indirizzo_lng
count <- dati$IMMARANK
n <- length(count)
x <- indirizzo.lng
y <- indirizzo.lat
dat <- data.frame(x,y)
totale <- ppp(x,y, c(min(x),max(x)),c(min(y),max(y)))
qk <- SpatialPointsDataFrame(coords=data.frame(x,y),data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
##kde
x <- rep(indirizzo.lng,1)
y <- rep(indirizzo.lat,1)
dat <- data.frame(x,y)
dat <- dat[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00),]
qk <- SpatialPointsDataFrame(coords=dat,data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
load("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/mat1")
#mat1 <- Hpi(dat,Hstart=mat1)
densita <- kde(x=dat, H=mat1, compute.cont=TRUE,w=count[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00)])
png(file = paste("kde.png",sep=""), width=SGqk$width*5, height=SGqk$height*5,bg="transparent")
par(mar=c(0,0,0,0), xaxs="i", yaxs="i")
plot(qk,setParUsrBB=TRUE)
plot(densita, display="filled.contour2", cont=c(20,50,75),add=T,xlim=SGqk$xlim, ylim=SGqk$ylim)
plot(densita, drawpoints=F, drawlabels=T, col="blue", lwd=4, cex=0.1,add=T)
dev.off()
densita.png <- paste("kde.png",sep="")
densita.kml <- paste("kde.kmz",sep="")
kmlOverlay(SGqk,densita.kml,densita.png)
#costruzione kml
center.lng <- 9.47
center.lat <- 45.46
dir <- paste(path[i],sep="")  #senza "/"
source("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/source.creazionekml.totale.r")
i <- i+1
}
if(i>length(path)) break
}
path <- 0
public.link <- 0
query <- data.frame()
for(i in 2:length(l)){
for(j in 1:length(l[[i]])){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/coorte/",anni,"/",l[[i]][j],sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/coorte/",anni,"/",l[[i]][j],sep=""))
query <- rbind(query,data.frame(names(l)[i],anni,l[[i]][j]))
}
}
names(query) <- c("facolta","anni","cdl")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
query$cdl <- paste(query$cdl)
dati1 <- read.table("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/Tot_facol_completo1.txt",header=T)
test <- subset(dati1,select=c("IST_REG","IST_LUOGO","IST_VIA","norm"))
test <- sqldf("select * from test order by IST_REG, IST_LUOGO")
indirizzo <- dati1$IST_VIA
luogo <- dati1$IST_LUOGO
i <- data.frame(indirizzo,luogo)
i <- unique(i)
i <- paste(i[,1],i[,2],sep="")
write(i,"vie.txt")
dati1 <- subset(dati1,indirizzo.lat!="0")
dati1$cdl_cod_primo <- paste(dati1$cdl_cod_primo)
dati1$cdl_cod_primo[which(dati1$cdl_cod_primo=="")] <- ""
levels(dati1$cdl_desc) <-
c(
'',
'BIOTECNOLOGIE',
'DISCIPLINE RICERCA PSICOL-SOC',
'ECON DELLE BANCHE DELLE ASS',
'ECON E AMMIN IMPRESE',
'ECON E COMMERCIO',
'ECON E GEST DEI SERV TUR',
'ECON STAT E INFO',
'FISICA',
'FISIOTERAPIA',
'GIURISPRUDENZA',
'IGIENE DENTALE',
'INFERMIERISTICA',
'INFORMATICA',
'MARK COM E MER INTERN',
'MATEMATICA',
'MEDICINA E CHIRURGIA',
'ODONTOIATRIA',
'OSTETRICIA',
'OTTICA E OPTOMETRIA',
'SC DEI MATERIALI',
'SC BIOLOGICHE',
'SC COM INTERCULTURALE',
'PSIC DELLA COMUNI',
'SC DEL TURISMO E COMUNITA LOCALE',
'SC DEL TURISMO E COMUNITA LOCALE A DISTANZA',
'SC EDUCAZIONE',
'SC ORGANIZZAZIONE',
'SC DELLA FORMAZ PRIMARIA',
'SC E TEC PSICOLOGICHE',
'SC E TEC CHIMICHE',
'SC E TEC GEOLOGICHE',
'SC E TEC ORAFE',
'SC E TEC PER AMBIENTE',
'SC OPERATORI DEI SERVIZI GIURIDICI',
'SC STAT ED ECONOMICHE',
'SERVIZIO SOCIALE',
'SOCIOLOGIA',
'STAT E GESTIONE DELLE INFO',
'TECNICHE DI LABOR BIOMEDICO',
'TECNICHE DI LABOR BIOMEDICO',
'TECNICHE DI RADIOLOGIA MEDICA',
'TERAPIA DELLA NEURO',
'TERAPIA DELLA NEURO')
dati1$cdl_desc <- paste(dati1$cdl_desc)
dati1$cdl_desc[which(dati1$cdl_desc=="")] <- "TOT X FACOLTA"
dati1$COORTE[which(dati1$COORTE==3000)] <- "2008-2010"
desc <- paste(dati1$IMMARANK_desc)
library(spatstat)
library(ks)
library(MASS)
library(sp)
library(maptools)
library(googleVis)
library(sqldf)
#tree generale delle cartelle
#l <- list()
#l$ateneo <- c("")
#l$economia        <- c("505","506","507","508","511","569")
#l$giurisprudenza  <- c("532","581")
#l$medicina    <- c("513","514","515","518","519","538","539","540","570","I0101D","I0102D","I0201D","I0202D","I0301D","I0302D","I0303D")
#l$psicologia  <- c("527","567","X25")
#l$scienze     <- c("501","502","512","516","517","520","521","522","528","529","530")
#l$formazione  <- c("524","R02","Y25")
#l$statistica  <- c("533","580")
#l$sociologia  <- c("523","535","536","541","579")
l <- list()
l$ateneo <- c("")
l$economia        <- c("ECON DELLE BANCHE DELLE ASS","ECON E AMMIN IMPRESE","ECON E COMMERCIO","ECON E GEST DEI SERV TUR","ECON STAT E INFO","MARK COM E MER INTERN")
l$giurisprudenza  <- c("SC OPERATORI DEI SERVIZI GIURIDICI","GIURISPRUDENZA")
l$medicina    <- c("FISIOTERAPIA","IGIENE DENTALE","INFERMIERISTICA","MEDICINA E CHIRURGIA","OSTETRICIA",
"TECNICHE DI LABOR BIOMEDICO","TECNICHE DI RADIOLOGIA MEDICA","TERAPIA DELLA NEURO","ODONTOIATRIA")
l$psicologia  <- c("SC E TEC PSICOLOGICHE","DISCIPLINE RICERCA PSICOL-SOC","SC COM INTERCULTURALE")
l$scienze     <- c("BIOTECNOLOGIE","SC E TEC CHIMICHE","FISICA","INFORMATICA","MATEMATICA",
"OTTICA E OPTOMETRIA","SC DEI MATERIALI","SC BIOLOGICHE","SC E TEC GEOLOGICHE","SC E TEC ORAFE","SC E TEC PER AMBIENTE")
l$formazione  <- c("SC EDUCAZIONE","SC DELLA FORMAZ PRIMARIA","SC COM INTERCULTURALE")
l$statistica  <- c("SC STAT ED ECONOMICHE","STAT E GESTIONE DELLE INFO")
l$sociologia  <- c("SC DEL TURISMO E COMUNITA LOCALE","SERVIZIO SOCIALE","SOCIOLOGIA",
"SC DEL TURISMO E COMUNITA LOCALE A DISTANZA","SC ORGANIZZAZIONE")
anni <- 2008:2010
###################################################################COORTE
path <- 0
public.link <- 0
query <- data.frame()
for(i in 2:length(l)){
for(j in 1:length(l[[i]])){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/coorte/",anni,"/",l[[i]][j],sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/coorte/",anni,"/",l[[i]][j],sep=""))
query <- rbind(query,data.frame(names(l)[i],anni,l[[i]][j]))
}
}
names(query) <- c("facolta","anni","cdl")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
query$cdl <- paste(query$cdl)
dati1 <- read.table("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/Tot_facol_completo1.txt",header=T)
test <- subset(dati1,select=c("IST_REG","IST_LUOGO","IST_VIA","norm"))
test <- sqldf("select * from test order by IST_REG, IST_LUOGO")
indirizzo <- dati1$IST_VIA
luogo <- dati1$IST_LUOGO
i <- data.frame(indirizzo,luogo)
i <- unique(i)
i <- paste(i[,1],i[,2],sep="")
write(i,"vie.txt")
dati1 <- subset(dati1,indirizzo.lat!="0")
dati1$cdl_cod_primo <- paste(dati1$cdl_cod_primo)
dati1$cdl_cod_primo[which(dati1$cdl_cod_primo=="")] <- ""
levels(dati1$cdl_desc) <-
c(
'',
'BIOTECNOLOGIE',
'DISCIPLINE RICERCA PSICOL-SOC',
'ECON DELLE BANCHE DELLE ASS',
'ECON E AMMIN IMPRESE',
'ECON E COMMERCIO',
'ECON E GEST DEI SERV TUR',
'ECON STAT E INFO',
'FISICA',
'FISIOTERAPIA',
'GIURISPRUDENZA',
'IGIENE DENTALE',
'INFERMIERISTICA',
'INFORMATICA',
'MARK COM E MER INTERN',
'MATEMATICA',
'MEDICINA E CHIRURGIA',
'ODONTOIATRIA',
'OSTETRICIA',
'OTTICA E OPTOMETRIA',
'SC DEI MATERIALI',
'SC BIOLOGICHE',
'SC COM INTERCULTURALE',
'PSIC DELLA COMUNI',
'SC DEL TURISMO E COMUNITA LOCALE',
'SC DEL TURISMO E COMUNITA LOCALE A DISTANZA',
'SC EDUCAZIONE',
'SC ORGANIZZAZIONE',
'SC DELLA FORMAZ PRIMARIA',
'SC E TEC PSICOLOGICHE',
'SC E TEC CHIMICHE',
'SC E TEC GEOLOGICHE',
'SC E TEC ORAFE',
'SC E TEC PER AMBIENTE',
'SC OPERATORI DEI SERVIZI GIURIDICI',
'SC STAT ED ECONOMICHE',
'SERVIZIO SOCIALE',
'SOCIOLOGIA',
'STAT E GESTIONE DELLE INFO',
'TECNICHE DI LABOR BIOMEDICO',
'TECNICHE DI LABOR BIOMEDICO',
'TECNICHE DI RADIOLOGIA MEDICA',
'TERAPIA DELLA NEURO',
'TERAPIA DELLA NEURO')
dati1$cdl_desc <- paste(dati1$cdl_desc)
dati1$cdl_desc[which(dati1$cdl_desc=="")] <- "TOT X FACOLTA"
dati1$COORTE[which(dati1$COORTE==3000)] <- "2008-2010"
desc <- paste(dati1$IMMARANK_desc)
path <- 0
public.link <- 0
query <- data.frame()
for(i in 1:length(l)){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/totale/",sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/totale/",sep=""))
query <- rbind(query,data.frame(names(l)[i]))
}
names(query) <- c("facolta")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
codici.fac <- c("")      #inserisco tra i totali anche l'ateneo: ""
i <- 1
while(i <= length(codici.fac)){   #9==num facolta
print(i)
setwd(path[i])
#eseguo la query
dati <- sqldf(paste("select * from dati1 where facol_cod_primo=='",codici.fac[i],"' and COORTE='2008-2010' and cdl_cod_primo==''",sep=""))
sel <- dati$IMMARANK
sel.desc <- unique(data.frame(dati$IMMARANK,dati$IMMARANK_desc))
sel.desc <- sel.desc[order(sel.desc[,1]),]
names(sel.desc) <- c("IMMARANK","IMMARANK_desc")
print(dim(sel.desc))
if(dim(dati)[1]==0){
i <- i+1
}
else{
#costruzione variabili
indirizzo.lat <- dati$indirizzo_lat
indirizzo.lng <- dati$indirizzo_lng
count <- dati$IMMARANK
n <- length(count)
x <- indirizzo.lng
y <- indirizzo.lat
dat <- data.frame(x,y)
totale <- ppp(x,y, c(min(x),max(x)),c(min(y),max(y)))
qk <- SpatialPointsDataFrame(coords=data.frame(x,y),data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
##kde
x <- rep(indirizzo.lng,1)
y <- rep(indirizzo.lat,1)
dat <- data.frame(x,y)
dat <- dat[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00),]
qk <- SpatialPointsDataFrame(coords=dat,data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
load("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/mat1")
#mat1 <- Hpi(dat,Hstart=mat1)
densita <- kde(x=dat, H=mat1, compute.cont=TRUE,w=count[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00)])
png(file = paste("kde.png",sep=""), width=SGqk$width*5, height=SGqk$height*5,bg="transparent")
par(mar=c(0,0,0,0), xaxs="i", yaxs="i")
plot(qk,setParUsrBB=TRUE)
plot(densita, display="filled.contour2", cont=c(20,50,75),add=T,xlim=SGqk$xlim, ylim=SGqk$ylim)
plot(densita, drawpoints=F, drawlabels=T, col="blue", lwd=4, cex=0.1,add=T)
dev.off()
densita.png <- paste("kde.png",sep="")
densita.kml <- paste("kde.kmz",sep="")
kmlOverlay(SGqk,densita.kml,densita.png)
#costruzione kml
center.lng <- 9.47
center.lat <- 45.46
dir <- paste(path[i],sep="")  #senza "/"
source("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/source.creazionekml.totale.r")
i <- i+1
}
if(i>length(path)) break
}
path <- 0
public.link <- 0
query <- data.frame()
for(i in 1:length(l)){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/totale/",sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/totale/",sep=""))
query <- rbind(query,data.frame(names(l)[i]))
}
names(query) <- c("facolta")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
codici.fac <- c("")      #inserisco tra i totali anche l'ateneo: ""
i <- 1
while(i <= length(codici.fac)){   #9==num facolta
print(i)
setwd(path[i])
#eseguo la query
dati <- sqldf(paste("select * from dati1 where facol_cod_primo=='",codici.fac[i],"' and COORTE='2008-2010' and cdl_cod_primo==''",sep=""))
sel <- dati$IMMARANK
sel.desc <- unique(data.frame(dati$IMMARANK,dati$IMMARANK_desc))
sel.desc <- sel.desc[order(sel.desc[,1]),]
names(sel.desc) <- c("IMMARANK","IMMARANK_desc")
print(dim(sel.desc))
if(dim(dati)[1]==0){
i <- i+1
}
else{
#costruzione variabili
indirizzo.lat <- dati$indirizzo_lat
indirizzo.lng <- dati$indirizzo_lng
count <- dati$IMMARANK
n <- length(count)
x <- indirizzo.lng
y <- indirizzo.lat
dat <- data.frame(x,y)
totale <- ppp(x,y, c(min(x),max(x)),c(min(y),max(y)))
qk <- SpatialPointsDataFrame(coords=data.frame(x,y),data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
##kde
x <- rep(indirizzo.lng,1)
y <- rep(indirizzo.lat,1)
dat <- data.frame(x,y)
dat <- dat[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00),]
qk <- SpatialPointsDataFrame(coords=dat,data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
load("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/mat1")
#mat1 <- Hpi(dat,Hstart=mat1)
densita <- kde(x=dat, H=mat1, compute.cont=TRUE,w=count[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00)])
png(file = paste("kde.png",sep=""), width=SGqk$width*5, height=SGqk$height*5,bg="transparent")
par(mar=c(0,0,0,0), xaxs="i", yaxs="i")
plot(qk,setParUsrBB=TRUE)
plot(densita, display="filled.contour2", cont=c(20,50,75),add=T,xlim=SGqk$xlim, ylim=SGqk$ylim)
plot(densita, drawpoints=F, drawlabels=T, col="blue", lwd=4, cex=0.1,add=T)
dev.off()
densita.png <- paste("kde.png",sep="")
densita.kml <- paste("kde.kmz",sep="")
kmlOverlay(SGqk,densita.kml,densita.png)
#costruzione kml
center.lng <- 9.47
center.lat <- 45.46
dir <- paste(path[i],sep="")  #senza "/"
source("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/source.creazionekml.totale.r")
i <- i+1
}
if(i>length(path)) break
}
path <- 0
public.link <- 0
query <- data.frame()
for(i in 1:length(l)){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/totale/",sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/totale/",sep=""))
query <- rbind(query,data.frame(names(l)[i]))
}
names(query) <- c("facolta")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
codici.fac <- c("","M","A","D","P","Q","R","B","N")      #inserisco tra i totali anche l'ateneo: ""
i <- 1
while(i <= length(codici.fac)){   #9==num facolta
print(i)
setwd(path[i])
#eseguo la query
dati <- sqldf(paste("select * from dati1 where facol_cod_primo=='",codici.fac[i],"' and COORTE='2008-2010' and cdl_cod_primo==''",sep=""))
sel <- dati$IMMARANK
sel.desc <- unique(data.frame(dati$IMMARANK,dati$IMMARANK_desc))
sel.desc <- sel.desc[order(sel.desc[,1]),]
names(sel.desc) <- c("IMMARANK","IMMARANK_desc")
print(dim(sel.desc))
if(dim(dati)[1]==0){
i <- i+1
}
else{
#costruzione variabili
indirizzo.lat <- dati$indirizzo_lat
indirizzo.lng <- dati$indirizzo_lng
count <- dati$IMMARANK
n <- length(count)
x <- indirizzo.lng
y <- indirizzo.lat
dat <- data.frame(x,y)
totale <- ppp(x,y, c(min(x),max(x)),c(min(y),max(y)))
qk <- SpatialPointsDataFrame(coords=data.frame(x,y),data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
##kde
x <- rep(indirizzo.lng,1)
y <- rep(indirizzo.lat,1)
dat <- data.frame(x,y)
dat <- dat[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00),]
qk <- SpatialPointsDataFrame(coords=dat,data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
load("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/mat1")
#mat1 <- Hpi(dat,Hstart=mat1)
densita <- kde(x=dat, H=mat1, compute.cont=TRUE,w=count[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00)])
png(file = paste("kde.png",sep=""), width=SGqk$width*5, height=SGqk$height*5,bg="transparent")
par(mar=c(0,0,0,0), xaxs="i", yaxs="i")
plot(qk,setParUsrBB=TRUE)
plot(densita, display="filled.contour2", cont=c(20,50,75),add=T,xlim=SGqk$xlim, ylim=SGqk$ylim)
plot(densita, drawpoints=F, drawlabels=T, col="blue", lwd=4, cex=0.1,add=T)
dev.off()
densita.png <- paste("kde.png",sep="")
densita.kml <- paste("kde.kmz",sep="")
kmlOverlay(SGqk,densita.kml,densita.png)
#costruzione kml
center.lng <- 9.47
center.lat <- 45.46
dir <- paste(path[i],sep="")  #senza "/"
source("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/source.creazionekml.totale.r")
i <- i+1
}
if(i>length(path)) break
}
codici.fac <- c("M","A","D","P","Q","R","B","N")     #tolgo l'ateneo visto che il cdl non centra
path <- 0
public.link <- 0
query <- data.frame()
for(i in 2:length(l)){
path  <- c(path,paste("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/analisiscuole/site/",names(l)[i],"/kml/cdl/",l[[i]],sep=""))
public.link  <- c(public.link,paste("http://dl.dropbox.com/u/51118288/studio/alessio4/",names(l)[i],"/kml/cdl/",l[[i]],sep=""))
query <- rbind(query,data.frame(names(l)[i],l[[i]]))
}
names(query) <- c("facolta","cdl")
path <- path[-1]               #per posizionare i KML
public.link <- public.link[-1] #per href  KML
query$cdl <- paste(query$cdl)
i <- 1
while(i <= length(path)){
print(i)
setwd(path[i])
#eseguo la query
dati <- sqldf(paste("select * from dati1 where COORTE='2008-2010' and cdl_desc=='",query[i,2],"'",sep=""))
sel <- dati$IMMARANK
sel.desc <- unique(data.frame(dati$IMMARANK,dati$IMMARANK_desc))
sel.desc <- sel.desc[order(sel.desc[,1]),]
names(sel.desc) <- c("IMMARANK","IMMARANK_desc")
if(dim(sel.desc)[1]>3){
seldesc <- sel.desc
sel.desc <- sqldf(paste("select * from seldesc group by IMMARANK",sep=""))
}
print(dim(sel.desc))
if(dim(dati)[1]==0){
i <- i+1
}
else{
#costruzione variabili
indirizzo.lat <- dati$indirizzo_lat
indirizzo.lng <- dati$indirizzo_lng
count <- dati$IMMARANK
n <- length(count)
x <- indirizzo.lng
y <- indirizzo.lat
dat <- data.frame(x,y)
totale <- ppp(x,y, c(min(x),max(x)),c(min(y),max(y)))
qk <- SpatialPointsDataFrame(coords=data.frame(x,y),data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
##kde
x <- rep(indirizzo.lng,1)
y <- rep(indirizzo.lat,1)
dat <- data.frame(x,y)
dat <- dat[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00),]
qk <- SpatialPointsDataFrame(coords=dat,data=dat)  #tutti
proj4string(qk) <- CRS("+proj=longlat") #cordinate system
SGqk <- GE_SpatialGrid(qk)
load("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/mat1")
#mat1 <- Hpi(dat,Hstart=mat1)
densita <- kde(x=dat, H=mat1, compute.cont=TRUE,w=count[which(dat[,1]<10.2 & dat[,1]>8.22 & dat[,2]<46.33 & dat[,2]>45.00)])
png(file = paste("kde.png",sep=""), width=SGqk$width*5, height=SGqk$height*5,bg="transparent")
par(mar=c(0,0,0,0), xaxs="i", yaxs="i")
plot(qk,setParUsrBB=TRUE)
plot(densita, display="filled.contour2", cont=c(20,50,75),add=T,xlim=SGqk$xlim, ylim=SGqk$ylim)
plot(densita, drawpoints=F, drawlabels=T, col="blue", lwd=4, cex=0.1,add=T)
dev.off()
densita.png <- paste("kde.png",sep="")
densita.kml <- paste("kde.kmz",sep="")
kmlOverlay(SGqk,densita.kml,densita.png)
#costruzione kml
dir <- paste(path[i],sep="")  #senza "/"
source("C:/Users/Stefano/Documents/Stefano/LAVORO/ALESSIO/source.creazionekml.cdl.r")
i <- i+1
}
if(i>length(path)) break
}
